@page "/discussions/upload"
@using System.Globalization
@using System.Security.Cryptography
@using AssemblyAI;
@using AssemblyAI.Transcripts;
@using System.Text
@inject IWebHostEnvironment WebHostEnvironment
@inject IConfiguration Configuration

<h4>Upload Audio Clips</h4>

<div class="form-group">
    <div class="input-group mb-3">
        @if (fileInputVisible)
        {
            <InputFile OnChange="HandleSelected" multiple class="form-control-file" />
        }
        <button @onclick="UploadFiles" class="btn btn-primary" disabled="@isUploadButtonDisabled">@uploadButtonText</button>
    </div>
    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="alert alert-danger" role="alert">
            @Error
        </div>
    }
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success" role="alert">
            @SuccessMessage
        </div>
    }
</div>

<div class="form-group">
    <h4>Process Files</h4>
    <div class="input-group mb-3 flex-column flex-sm-row">
        <select @bind="SelectedMonth" class="form-control mb-2 mb-sm-0 mr-sm-2" style="width: auto;">
            @foreach (var month in Months)
            {
                <option value="@month">@month</option>
            }
        </select>

        <select @bind="SelectedYear" class="form-control mb-2 mb-sm-0 mr-sm-2" style="width: auto;">
            @foreach (var year in Years)
            {
                <option value="@year">@year</option>
            }
        </select>

        <input type="password" @bind="PIN" placeholder="Enter PIN" class="form-control mb-2 mb-sm-0 mr-sm-2" style="width: auto;" />
        <button @onclick="ProcessFiles" class="btn btn-primary" disabled="@Processing">Process</button>
    </div>
</div>

@code {
    private bool Processing = false;
    private bool isUploadButtonDisabled = true;
    private bool fileInputVisible = true;
    private string SelectedMonth { get; set; } = DateTime.Now.ToString("MMMM");
    private int SelectedYear { get; set; } = DateTime.Now.Year;
    private List<string> Months = CultureInfo.CurrentCulture.DateTimeFormat.MonthNames.Take(12).ToList();
    private List<int> Years = Enumerable.Range(DateTime.Now.Year - 20, 21).ToList();
    private List<IBrowserFile> selectedFiles = new List<IBrowserFile>();
    public string Error = string.Empty;
    public string SuccessMessage = string.Empty;
    private string PIN { get; set; } = "";
    private string uploadButtonText = "Upload";
    private AssemblyAIClient client;

    protected override void OnInitialized()
    {
        var apiKey = Configuration["AssemblyAI:ApiKey"];
        client = new AssemblyAIClient(apiKey);
    }

    private void HandleSelected(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles().ToList();
        isUploadButtonDisabled = !selectedFiles.Any();
    }

    private async Task UploadFiles()
    {
        const long maxFileSize = 2L * 1024 * 1024 * 1024; // 2 GB limit
        uploadButtonText = "Please wait... Uploading";
        isUploadButtonDisabled = true;
        Error = string.Empty;
        SuccessMessage = string.Empty;

        foreach (var file in selectedFiles)
        {
            if (file.Size > maxFileSize)
            {
                Error = "File size exceeds the 2 GB limit.";
                uploadButtonText = "Upload";
                isUploadButtonDisabled = false;
                return;
            }

            try
            {
                var uploadsFolder = Path.Combine(WebHostEnvironment.WebRootPath, "uploads");
                if (!Directory.Exists(uploadsFolder))
                {
                    Directory.CreateDirectory(uploadsFolder);
                }

                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
                var filePath = Path.Combine(uploadsFolder, fileName);

                using (var stream = new FileStream(filePath, FileMode.Create))
                {
                    await file.OpenReadStream(maxFileSize).CopyToAsync(stream);
                }

                SuccessMessage = "File(s) uploaded successfully.";
            }
            catch (Exception ex)
            {
                Error = $"An error occurred while uploading the file: {ex.Message}";
                uploadButtonText = "Upload";
                isUploadButtonDisabled = false;
                return;
            }
        }

        selectedFiles.Clear();
        isUploadButtonDisabled = true;
        uploadButtonText = "Upload";

        fileInputVisible = false;
        StateHasChanged();
        await Task.Delay(100);
        fileInputVisible = true;
    }

    private async Task ProcessFiles()
    {
        const string correctPIN = "9021";
        if (PIN != correctPIN)
        {
            Error = "Invalid PIN.";
            return;
        }

        Processing = true;
        Error = "";
        SuccessMessage = "";

        try
        {
            var uploadsFolder = Path.Combine(WebHostEnvironment.WebRootPath, "uploads");
            var targetFolder = Path.Combine(uploadsFolder, $"{SelectedMonth}-{SelectedYear}");
            if (!Directory.Exists(targetFolder))
            {
                Directory.CreateDirectory(targetFolder);
            }

            var processedHashes = new HashSet<string>();

            foreach (var file in Directory.GetFiles(uploadsFolder))
            {
                var fileInfo = new FileInfo(file);
                if (fileInfo.DirectoryName == targetFolder) continue;

                var fileHash = await GetFileHashAsync(file);
                if (processedHashes.Contains(fileHash))
                {
                    File.Delete(file);
                    continue;
                }

                processedHashes.Add(fileHash);

                var uniqueGuid = Guid.NewGuid().ToString();
                var newFileName = $"{SelectedMonth}-{SelectedYear}-{uniqueGuid}{fileInfo.Extension}";
                var destFileName = Path.Combine(targetFolder, newFileName);

                if (IsAudioFile(file))
                {
                    var transcript = await TranscribeAudioAsync(file);
                    if (!string.IsNullOrEmpty(transcript))
                    {
                        var transcriptFileName = $"{SelectedMonth}-{SelectedYear}-{uniqueGuid}.txt";
                        var transcriptPath = Path.Combine(targetFolder, transcriptFileName);
                        await File.WriteAllTextAsync(transcriptPath, transcript);

                        // Move the audio file only after successful transcription
                        File.Move(fileInfo.FullName, destFileName);
                    }
                    else
                    {
                        // If transcription failed, log an error but don't move the file
                        Error += $"\nFailed to transcribe: {fileInfo.Name}";
                    }
                }
                else
                {
                    // For non-audio files, move them immediately
                    File.Move(fileInfo.FullName, destFileName);
                }
            }

            SuccessMessage = "Files processed successfully.";
        }
        catch (Exception ex)
        {
            Error = $"An error occurred while processing the files: {ex.Message}";
        }

        Processing = false;
    }

    private async Task<string> GetFileHashAsync(string filePath)
    {
        using var md5 = MD5.Create();
        using var stream = File.OpenRead(filePath);
        var hash = await md5.ComputeHashAsync(stream);
        return BitConverter.ToString(hash).Replace("-", "").ToLowerInvariant();
    }

    private bool IsAudioFile(string filePath)
    {
        var audioExtensions = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            // Common audio file extensions
            ".mp3", ".wav", ".ogg", ".flac", ".aac", ".m4a", ".wma",

            // Video file extensions that may contain audio
            ".mp4", ".mov", ".avi", ".mkv", ".webm",

            // Apple-specific formats
            ".m4v", ".3gp",

            // Additional formats
            ".aiff", ".ac3", ".amr"
        };

        return audioExtensions.Contains(Path.GetExtension(filePath));
    }

    private async Task<string> TranscribeAudioAsync(string filePath)
    {
        try
        {
            var uploadedFile = await client.Files.UploadAsync(new FileInfo(filePath));
            var transcriptParams = new AssemblyAI.Transcripts.TranscriptParams
                {
                    AudioUrl = uploadedFile.UploadUrl,
                    SpeakerLabels = true  // Enable speaker diarization
                };

            var transcript = await client.Transcripts.TranscribeAsync(transcriptParams);
            transcript.EnsureStatusCompleted();

            if (transcript.Status == AssemblyAI.Transcripts.TranscriptStatus.Completed)
            {
                return FormatTranscriptWithSpeakers(transcript);
            }
            else
            {
                Error += $"\nTranscription failed: {transcript.Status}";
                return null;
            }
        }
        catch (Exception ex)
        {
            Error += $"\nTranscription error: {ex.Message}";
            return null;
        }
    }

    private string FormatTranscriptWithSpeakers(AssemblyAI.Transcripts.Transcript transcript)
    {
        if (transcript.Utterances == null || !transcript.Utterances.Any())
        {
            return transcript.Text; // Return the full text if no utterances are available
        }

        var formattedTranscript = new StringBuilder();
        foreach (var utterance in transcript.Utterances)
        {
            formattedTranscript.AppendLine($"Speaker {utterance.Speaker}: {utterance.Text}");
        }
        return formattedTranscript.ToString();
    }
}